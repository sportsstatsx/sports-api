<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Board Posts</title>
  <style>
    :root {
      --bg: #0b0d10;
      --panel: #11141a;
      --panel2: #0f1218;
      --text: #e6e9ef;
      --muted: rgba(230, 233, 239, 0.7);
      --line: rgba(230, 233, 239, 0.12);
      --line2: rgba(230, 233, 239, 0.18);
      --accent: #46d39a;
      --danger: #ff5a6a;
      --warn: #ffcc66;
      --shadow: 0 10px 40px rgba(0,0,0,0.35);
      --radius: 14px;
      --radius2: 18px;
      --pad: 14px;
      --pad2: 18px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      --sans: -apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
    }

    @media (prefers-color-scheme: light) {
      :root {
        --bg: #f5f7fb;
        --panel: #ffffff;
        --panel2: #ffffff;
        --text: #0b0d10;
        --muted: rgba(11, 13, 16, 0.6);
        --line: rgba(11, 13, 16, 0.12);
        --line2: rgba(11, 13, 16, 0.16);
        --shadow: 0 10px 40px rgba(10,20,30,0.10);
      }
    }

    body {
      margin: 0;
      padding: 18px;
      background: var(--bg);
      color: var(--text);
      font-family: var(--sans);
    }

    h1 {
      margin: 0 0 12px 0;
      font-size: 22px;
      letter-spacing: 0.2px;
    }

    .topbar {
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      margin-bottom: 14px;
    }

    .hint {
      font-size: 12px;
      color: var(--muted);
    }

    .wrap {
      display: grid;
      grid-template-columns: 420px 1fr;
      gap: 14px;
      align-items: start;
    }

    .card {
      background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01));
      border: 1px solid var(--line);
      border-radius: var(--radius2);
      box-shadow: var(--shadow);
      overflow: hidden;
    }

    .card h2 {
      margin: 0;
      padding: 12px 14px;
      font-size: 14px;
      color: var(--text);
      border-bottom: 1px solid var(--line);
      background: rgba(255,255,255,0.02);
    }

    .card .body {
      padding: 14px;
    }

    .row { display:flex; gap:10px; flex-wrap: wrap; align-items: center; }
    .col { display:flex; flex-direction: column; gap: 6px; }
    label { font-size: 12px; color: var(--muted); }
    input, select, textarea {
      width: 100%;
      padding: 10px 10px;
      font-size: 13px;
      border-radius: 12px;
      border: 1px solid var(--line2);
      background: rgba(0,0,0,0.15);
      color: var(--text);
      outline: none;
    }
    textarea { min-height: 170px; resize: vertical; font-family: var(--mono); line-height: 1.35; }

    .btn {
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid var(--line2);
      background: rgba(255,255,255,0.03);
      color: var(--text);
      cursor: pointer;
      font-weight: 600;
      font-size: 13px;
    }
    .btn:hover { border-color: rgba(255,255,255,0.28); }
    .btn.primary { border-color: rgba(70,211,154,0.55); }
    .btn.danger { border-color: rgba(255,90,106,0.55); color: var(--danger); }
    .btn.small { padding: 6px 10px; font-size: 12px; border-radius: 10px; }

    .list {
      display:flex;
      flex-direction: column;
      gap: 10px;
      max-height: 520px;
      overflow: auto;
      padding-right: 6px;
    }

    .item {
      border: 1px solid var(--line);
      border-radius: 14px;
      padding: 10px 12px;
      background: rgba(255,255,255,0.02);
      cursor: pointer;
    }

    .item:hover { border-color: rgba(255,255,255,0.25); }
    .item.active { border-color: rgba(70,211,154,0.7); box-shadow: 0 0 0 2px rgba(70,211,154,0.15) inset; }

    .item .meta {
      display:flex;
      justify-content: space-between;
      gap: 10px;
      align-items: center;
      color: var(--muted);
      font-size: 12px;
    }

    .item .title {
      margin-top: 6px;
      font-size: 14px;
      font-weight: 700;
      letter-spacing: 0.2px;
      word-break: break-word;
    }

    .badges { display:flex; gap: 6px; flex-wrap: wrap; align-items: center; }
    .badge {
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid var(--line2);
      background: rgba(255,255,255,0.03);
      color: var(--muted);
    }
    .badge.pub { border-color: rgba(70,211,154,0.55); color: var(--accent); }
    .badge.pin { border-color: rgba(255,204,102,0.55); color: var(--warn); }
    .badge.cat { color: var(--text); opacity: 0.9; }

    .split {
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    .mono {
      font-family: var(--mono);
      font-size: 12px;
      white-space: pre-wrap;
      word-break: break-word;
      padding: 10px;
      border-radius: 12px;
      border: 1px solid var(--line);
      background: rgba(0,0,0,0.18);
      max-height: 220px;
      overflow: auto;
    }

    .subtle {
      font-size: 12px;
      color: var(--muted);
      margin-top: 6px;
    }

    .langs {
      display:flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items: center;
    }
    .chip {
      display:inline-flex;
      gap: 6px;
      align-items: center;
      border: 1px solid var(--line2);
      border-radius: 999px;
      padding: 6px 10px;
      background: rgba(255,255,255,0.03);
      font-size: 12px;
      color: var(--text);
      cursor: pointer;
      user-select: none;
    }
    .chip input { width:auto; margin:0; }
  </style>
</head>
<body>
  <div class="topbar">
    <div>
      <h1>Board Posts</h1>
      <div class="hint">경로: <span id="pathHint"></span> · API 헤더: <code>X-Admin-Token</code> 필요</div>
    </div>
    <div class="row">
      <button class="btn" onclick="loadPosts()">불러오기</button>
      <button class="btn" onclick="newPost()">+ 새 글</button>
    </div>
  </div>

  <div class="wrap">
    <!-- Left: List -->
    <div class="card">
      <h2>Posts</h2>
      <div class="body">
        <div class="row">
          <div class="col" style="min-width: 110px; flex:1">
            <label>Status</label>
            <select id="qStatus">
              <option value="">(all)</option>
              <option value="draft">draft</option>
              <option value="published">published</option>
              <option value="hidden">hidden</option>
            </select>
          </div>
          <div class="col" style="min-width: 120px; flex:1">
            <label>Category</label>
            <select id="qCategory">
              <option value="">(all)</option>
              <option value="notice">notice</option>
              <option value="ops">ops</option>
              <option value="analysis">analysis</option>
            </select>
          </div>
          <div class="col" style="min-width: 120px; flex:1">
            <label>Sport</label>
            <select id="qSport">
              <option value="">(all)</option>
              <option value="football">football</option>
              <option value="hockey">hockey</option>
            </select>
          </div>
          <div class="col" style="min-width: 170px; flex:2">
            <label>Search (title/summary)</label>
            <input id="qText" placeholder="예: Arsenal / 공지 / injury" />
          </div>
        </div>

        <div class="row" style="margin-top: 10px;">
          <div class="col" style="flex: 1;">
            <label>Fixture Key (optional)</label>
            <input id="qFixtureKey" placeholder="예: football:123456 / hockey:2025-01-01-XYZ" />
          </div>
          <div class="col" style="min-width: 110px;">
            <label>&nbsp;</label>
            <button class="btn" onclick="loadPosts()">불러오기</button>
          </div>
        </div>

        <div class="subtle" id="listHint"></div>
        <div class="list" id="list"></div>
      </div>
    </div>

    <!-- Right: Editor -->
    <div class="card">
      <h2>Editor</h2>
      <div class="body">
        <div class="row">
          <div class="col" style="min-width: 100px;">
            <label>ID</label>
            <input id="pId" disabled placeholder="(new)" />
          </div>
          <div class="col" style="min-width: 140px; flex:1;">
            <label>Category</label>
            <select id="pCategory">
              <option value="analysis">analysis</option>
              <option value="notice">notice</option>
              <option value="ops">ops</option>
            </select>
          </div>
          <div class="col" style="min-width: 140px; flex:1;">
            <label>Status</label>
            <select id="pStatus">
              <option value="draft">draft</option>
              <option value="published">published</option>
              <option value="hidden">hidden</option>
            </select>
          </div>
          <div class="col" style="min-width: 160px; flex:1;">
            <label>Pin level</label>
            <select id="pPin">
              <option value="0">0 (일반)</option>
              <option value="1">1 (고정)</option>
              <option value="2">2 (공지/운영 최상단)</option>
            </select>
          </div>
        </div>

        <div class="row" style="margin-top: 10px;">
          <div class="col" style="min-width: 200px; flex:1;">
            <label>Sport (optional)</label>
            <select id="pSport">
              <option value="">(none)</option>
              <option value="football">football</option>
              <option value="hockey">hockey</option>
            </select>
          </div>
          <div class="col" style="min-width: 240px; flex:1;">
            <label>Fixture Key (optional)</label>
            <input id="pFixtureKey" placeholder="예: 123456" />
          </div>
        </div>

        <div class="row" style="margin-top: 10px;">
          <div class="col" style="min-width: 220px; flex:1;">
            <label>Publish at (optional)</label>
            <input id="pPublishAt" type="datetime-local" />
          </div>
          <div class="col" style="min-width: 220px; flex:1;">
            <label>Pin until (optional)</label>
            <input id="pPinUntil" type="datetime-local" />
          </div>
        </div>

        <div class="row" style="margin-top: 10px;">
          <div class="col" style="flex: 1;">
            <label>Title</label>
            <input id="pTitle" placeholder="제목" />
          </div>
        </div>

        <div class="row" style="margin-top: 10px;">
          <div class="col" style="flex: 1;">
            <label>Summary (list에 뽑힐 짧은 요약)</label>
            <input id="pSummary" placeholder="요약(선택)" />
          </div>
        </div>

        <div class="row" style="margin-top: 10px;">
          <div class="col" style="flex: 1;">
            <label>Content (Markdown)</label>
            <textarea id="pContent" placeholder="# 제목&#10;&#10;내용..."></textarea>
          </div>
        </div>

        <!-- 언어권만 사용 -->
        <div class="row" style="margin-top: 10px;">
          <div class="col" style="flex: 1;">
            <label>Target Langs (비우면 전세계)</label>
            <div class="langs" id="langBox"></div>
            <div class="subtle">예: 영어 글이면 <b>en</b>만 체크. 비우면 모든 언어권에 노출.</div>
          </div>
        </div>

        <div class="row" style="margin-top: 10px;">
          <div class="col" style="flex: 1;">
            <label>(옵션) Snapshot JSON / Filters JSON</label>
            <button class="btn small" onclick="toggleJsonPanel()">JSON 패널 열기/닫기</button>
          </div>
        </div>

        <div id="jsonPanel" style="display:none; margin-top: 10px;">
          <div class="split">
            <div class="col">
              <label>Filters JSON</label>
              <textarea id="pFiltersJson" style="min-height:140px;">{}</textarea>
            </div>
            <div class="col">
              <label>Snapshot JSON</label>
              <textarea id="pSnapshotJson" style="min-height:140px;">{}</textarea>
            </div>
          </div>
        </div>

        <div class="row" style="margin-top: 12px;">
          <button class="btn primary" onclick="savePost()">저장(Upsert)</button>
          <button class="btn danger" onclick="deletePost()">삭제</button>
          <button class="btn" onclick="reloadSelected()">새로고침</button>
          <div class="hint" id="saveHint" style="margin-left:auto;"></div>
        </div>

        <div class="subtle">Debug</div>
        <div class="mono" id="debugBox">{}</div>
      </div>
    </div>
  </div>

<script>
  // ─────────────────────────────────────
  // Helpers
  // ─────────────────────────────────────
  const LANG_OPTIONS = ["en", "es", "ko", "ja", "zh"]; // 필요하면 확장
  let cachedRows = [];
  let selectedId = null;

  function adminUrl(path) {
    return location.pathname.replace(/\\/pages\\/.+$/, "") + path;
  }

  function $(id) { return document.getElementById(id); }

  function setDebug(obj) {
    $("debugBox").textContent = JSON.stringify(obj, null, 2);
  }

  function setSaveHint(msg) { $("saveHint").textContent = msg || ""; }
  function setStatusLine(msg) { $("listHint").textContent = msg || ""; }

  function escapeHtml(s) {
    return String(s || "")
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#039;");
  }

  function isoToDatetimeLocal(iso) {
    if (!iso) return "";
    const d = new Date(iso);
    const pad = (n) => String(n).padStart(2, "0");
    const y = d.getFullYear();
    const m = pad(d.getMonth() + 1);
    const da = pad(d.getDate());
    const hh = pad(d.getHours());
    const mm = pad(d.getMinutes());
    return `${y}-${m}-${da}T${hh}:${mm}`;
  }

  function toIsoOrNull(datetimeLocal) {
    const v = (datetimeLocal || "").trim();
    if (!v) return null;
    const d = new Date(v);
    if (isNaN(d.getTime())) return null;
    return d.toISOString();
  }

  async function api(url, opts) {
    const token = localStorage.getItem("adminToken") || "";
    const headers = Object.assign({
      "Content-Type": "application/json",
      "X-Admin-Token": token,
    }, (opts && opts.headers) || {});
    const res = await fetch(url, Object.assign({}, opts || {}, { headers }));
    let data = null;
    try { data = await res.json(); } catch(e) {}
    return { status: res.status, data };
  }

  // ─────────────────────────────────────
  // Lang chips
  // ─────────────────────────────────────
  function renderLangBox() {
    const box = $("langBox");
    box.innerHTML = "";
    for (const code of LANG_OPTIONS) {
      const id = "lang_" + code;
      const chip = document.createElement("label");
      chip.className = "chip";
      chip.innerHTML = `<input type="checkbox" id="${id}" value="${code}"> <span>${code}</span>`;
      box.appendChild(chip);
    }
  }

  function getSelectedLangs() {
    const out = [];
    for (const code of LANG_OPTIONS) {
      const el = $("lang_" + code);
      if (el && el.checked) out.push(code);
    }
    return out;
  }

  function setSelectedLangs(arr) {
    const set = new Set((arr || []).map(x => String(x).toLowerCase().trim()).filter(Boolean));
    for (const code of LANG_OPTIONS) {
      const el = $("lang_" + code);
      if (el) el.checked = set.has(code);
    }
  }

  function toggleJsonPanel() {
    const p = $("jsonPanel");
    p.style.display = (p.style.display === "none" ? "block" : "none");
  }

  // ─────────────────────────────────────
  // List render
  // ─────────────────────────────────────
  function renderList() {
    const list = $("list");
    list.innerHTML = "";

    const rows = cachedRows || [];
    setStatusLine("rows: " + rows.length);

    for (const r of rows) {
      const div = document.createElement("div");
      div.className = "item" + (String(r.id) === String(selectedId) ? " active" : "");
      const badges = [];

      if (r.status === "published") badges.push(`<span class="badge pub">PUB</span>`);
      badges.push(`<span class="badge cat">${escapeHtml(r.category || "")}</span>`);
      if ((r.pin_level || 0) > 0) badges.push(`<span class="badge pin">PIN ${escapeHtml(String(r.pin_level))}</span>`);

      const tlangs = (r.target_langs || []);
      if (tlangs.length > 0) badges.push(`<span class="badge">langs: ${escapeHtml(tlangs.join(","))}</span>`);

      div.innerHTML = `
        <div class="meta">
          <div>#${escapeHtml(r.id)} · ${escapeHtml((r.publish_at || r.created_at || "").slice(0, 16))}</div>
          <div class="badges">${badges.join("")}</div>
        </div>
        <div class="title">${escapeHtml(r.title || "")}</div>
      `;
      div.onclick = () => selectPost(r.id);
      list.appendChild(div);
    }
  }

  // ─────────────────────────────────────
  // Load / Select
  // ─────────────────────────────────────
  async function loadPosts() {
    const qs = new URLSearchParams();
    const st = ($("qStatus").value || "").trim();
    const cat = ($("qCategory").value || "").trim();
    const sp = ($("qSport").value || "").trim();
    const q = ($("qText").value || "").trim();
    const fx = ($("qFixtureKey").value || "").trim();

    if (st) qs.set("status", st);
    if (cat) qs.set("category", cat);
    if (sp) qs.set("sport", sp);
    if (q) qs.set("q", q);
    if (fx) qs.set("fixture_key", fx);

    qs.set("limit", "200");
    qs.set("offset", "0");

    setStatusLine("불러오는 중...");
    const r = await api(adminUrl("/api/board/posts?" + qs.toString()), { method: "GET" });
    setDebug(r);

    if (r.status >= 400 || !r.data || !r.data.ok) {
      setStatusLine("");
      alert("로드 실패: " + JSON.stringify(r.data));
      return;
    }

    cachedRows = r.data.rows || [];
    setStatusLine("");
    renderList();

    if (selectedId) {
      const exists = cachedRows.find(x => String(x.id) === String(selectedId));
      if (!exists) selectedId = null;
      renderList();
    }
  }

  async function selectPost(id) {
    if (!id) return;
    selectedId = String(id);
    renderList();

    setStatusLine("불러오는 중: #" + id);
    const r = await api(adminUrl("/api/board/posts/" + id), { method: "GET" });
    setDebug(r);

    if (r.status >= 400 || !r.data || !r.data.ok) {
      setStatusLine("");
      alert("불러오기 실패: " + JSON.stringify(r.data));
      return;
    }

    fillEditor(r.data.row || {});
    setStatusLine("");
  }

  function clearEditor() {
    selectedId = null;
    $("pId").value = "";
    $("pCategory").value = "analysis";
    $("pStatus").value = "draft";
    $("pPin").value = "0";
    $("pSport").value = "";
    $("pFixtureKey").value = "";
    $("pPublishAt").value = "";
    $("pPinUntil").value = "";
    $("pTitle").value = "";
    $("pSummary").value = "";
    $("pContent").value = "";
    setSelectedLangs([]);
    $("pFiltersJson").value = "{}";
    $("pSnapshotJson").value = "{}";
    renderList();
  }

  function newPost() {
    clearEditor();
    setSaveHint("새 글 작성 중");
  }

  function fillEditor(row) {
    selectedId = String(row.id ?? "");
    $("pId").value = selectedId;

    $("pCategory").value = (row.category || "analysis");
    $("pStatus").value = (row.status || "draft");
    $("pPin").value = String(row.pin_level ?? 0);

    $("pSport").value = (row.sport || "");
    $("pFixtureKey").value = (row.fixture_key || "");

    $("pPublishAt").value = isoToDatetimeLocal(row.publish_at || "");
    $("pPinUntil").value = isoToDatetimeLocal(row.pin_until || "");

    $("pTitle").value = (row.title || "");
    $("pSummary").value = (row.summary || "");
    $("pContent").value = (row.content_md || "");

    setSelectedLangs(row.target_langs || []);

    try {
      const fj = row.filters_json ?? {};
      $("pFiltersJson").value = (typeof fj === "string") ? fj : JSON.stringify(fj, null, 2);
    } catch (e) {
      $("pFiltersJson").value = "{}";
    }
    try {
      const sj = row.snapshot_json ?? {};
      $("pSnapshotJson").value = (typeof sj === "string") ? sj : JSON.stringify(sj, null, 2);
    } catch (e) {
      $("pSnapshotJson").value = "{}";
    }

    setSaveHint("편집 중: #" + selectedId);
    renderList();
  }

  async function reloadSelected() {
    if (!selectedId) return alert("선택된 글이 없습니다.");
    await selectPost(selectedId);
  }

  // ─────────────────────────────────────
  // Save / Delete
  // ─────────────────────────────────────
  function buildPayload() {
    const title = ($("pTitle").value || "").trim();
    const content = ($("pContent").value || "").trim();

    const filtersStr = ($("pFiltersJson").value || "").trim() || "{}";
    const snapshotStr = ($("pSnapshotJson").value || "").trim() || "{}";

    let filtersObj = {};
    let snapshotObj = {};
    try { filtersObj = JSON.parse(filtersStr); } catch (e) { throw new Error("filters_json JSON 파싱 실패"); }
    try { snapshotObj = JSON.parse(snapshotStr); } catch (e) { throw new Error("snapshot_json JSON 파싱 실패"); }

    return {
      category: ($("pCategory").value || "analysis"),
      status: ($("pStatus").value || "draft"),
      pin_level: Number($("pPin").value || 0),

      sport: ($("pSport").value || "").trim() || null,
      fixture_key: ($("pFixtureKey").value || "").trim() || null,

      title,
      summary: ($("pSummary").value || "").trim(),
      content_md: content,

      publish_at: toIsoOrNull($("pPublishAt").value),
      pin_until: toIsoOrNull($("pPinUntil").value),

      // ✅ 언어권만
      target_langs: getSelectedLangs(),

      filters_json: filtersObj,
      snapshot_json: snapshotObj,
    };
  }

  async function savePost() {
    let payload = null;
    try {
      payload = buildPayload();
    } catch (e) {
      return alert(String(e.message || e));
    }

    if (!payload.title) return alert("title은 필수입니다.");
    if (!payload.content_md) return alert("content_md는 필수입니다.");

    if (payload.status === "published" && !payload.publish_at) {
      payload.publish_at = new Date().toISOString();
      $("pPublishAt").value = isoToDatetimeLocal(payload.publish_at);
    }

    const isNew = !selectedId;
    const ok = confirm(isNew ? "새 글을 저장할까요?" : ("글을 저장(업데이트)할까요? (#" + selectedId + ")"));
    if (!ok) return;

    setSaveHint("저장 중...");
    const path = isNew
      ? adminUrl("/api/board/posts")
      : adminUrl("/api/board/posts/" + selectedId);

    const method = isNew ? "POST" : "PUT";

    const r = await api(path, {
      method,
      body: JSON.stringify(payload),
    });
    setDebug(r);

    if (r.status >= 400 || !r.data || !r.data.ok) {
      setSaveHint("");
      alert("저장 실패: " + JSON.stringify(r.data));
      return;
    }

    if (isNew && r.data.id != null) {
      selectedId = String(r.data.id);
      $("pId").value = selectedId;
      setSaveHint("저장 완료: #" + selectedId);
      await loadPosts();
      await selectPost(selectedId);
    } else {
      setSaveHint("저장 완료");
      await loadPosts();
      if (selectedId) await selectPost(selectedId);
    }
  }

  async function deletePost() {
    if (!selectedId) return alert("삭제할 글을 먼저 선택하세요.");
    const ok = confirm("정말 삭제할까요? (#" + selectedId + ")");
    if (!ok) return;

    setSaveHint("삭제 중...");
    const r = await api(adminUrl("/api/board/posts/" + selectedId), { method: "DELETE" });
    setDebug(r);

    if (r.status >= 400 || !r.data || !r.data.ok) {
      setSaveHint("");
      alert("삭제 실패: " + JSON.stringify(r.data));
      return;
    }

    setSaveHint("삭제 완료");
    clearEditor();
    await loadPosts();
  }

  // Init
  $("pathHint").textContent = location.pathname;
  renderLangBox();
  loadPosts();
</script>
</body>
</html>
